<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>意见反馈｜加入社群</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0c0f;
      --panel: #11131a;
      --card: #151823;
      --text: #e6e6eb;
      --muted:#9aa0aa;
      --brand:#6aa4ff;
      --ok:#2ecc71;
      --warn:#f39c12;
      --danger:#e74c3c;
      --border: #232737;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --text:#11131a; --muted:#6b7280; --border:#e5e7eb; --shadow:0 10px 30px rgba(17,24,39,.06); }
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    .wrap{ max-width:960px; margin:32px auto; padding:0 16px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:36px; height:36px; border-radius:12px; background:linear-gradient(135deg, var(--brand), #9d7dff); box-shadow: var(--shadow); }
    h1{ font-size:20px; margin:0; }

    .tabs{ display:flex; gap:8px; background:var(--panel); border:1px solid var(--border); padding:6px; border-radius:14px; box-shadow: var(--shadow); position:sticky; top:8px; z-index:5; }
    .tab{ flex:1; text-align:center; padding:10px 12px; border-radius:10px; cursor:pointer; user-select:none; border:1px solid transparent; }
    .tab[aria-selected="true"]{ background:var(--card); border-color:var(--border); }
    .tab:focus-visible{ outline:2px solid var(--brand); outline-offset:2px; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; margin-top:16px; box-shadow: var(--shadow); }
    .row{ display:grid; grid-template-columns:150px 1fr; gap:12px; align-items:center; margin:12px 0; }
    .row textarea{ min-height:120px; }
    label{ color:var(--muted); font-size:14px; }
    input[type="text"], input[type="email"], select, textarea{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:transparent; color:var(--text); }
    textarea{ resize:vertical; }

    .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    button, .btn{ border:1px solid var(--border); background:var(--panel); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow); text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    button.primary, .btn.primary{ background:linear-gradient(135deg, var(--brand), #9d7dff); border:none; color:white; }
    .btn.success{ background:linear-gradient(135deg, #2ecc71, #27ae60); border:none; color:white; }
    .btn.warn{ background:linear-gradient(135deg, #f39c12, #e67e22); border:none; color:white; }
    .btn.disabled{ opacity:.55; cursor:not-allowed; pointer-events:none; }

    .muted{ color:var(--muted); font-size:13px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:16px; }
    .qr{ display:flex; flex-direction:column; align-items:center; gap:8px; }
    .kvs{ display:grid; grid-template-columns: 1fr auto; gap:8px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .stars{ display:flex; gap:6px; }
    .star{ width:28px; height:28px; border-radius:50%; display:grid; place-items:center; border:1px solid var(--border); cursor:pointer; }
    .star[aria-checked="true"]{ background:gold; color:#111; }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); }
    .badge.full{ background:linear-gradient(135deg, var(--warn), #e67e22); color:white; border:none; }

    .qrbox{
      width:180px; height:180px;
      border-radius:12px; border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; background:transparent;
    }

    footer{ margin:22px 4px; text-align:center; color:var(--muted); font-size:12px; }

    @media (max-width:640px){ .row{ grid-template-columns:1fr; } .tabs{ position:static; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>意见反馈 / 加入社群</h1>
          <div class="muted">静态单页 · 适配 GitHub Pages · 无后端</div>
        </div>
      </div>
      <a class="btn" id="ghLink" target="_blank" rel="noopener">查看仓库</a>
    </header>

    <nav class="tabs" role="tablist" aria-label="反馈/社群切换">
      <div class="tab" role="tab" id="tab-feedback"
           aria-controls="panel-feedback" aria-selected="true" tabindex="0"
           data-tab="feedback">提交反馈</div>
      <div class="tab" role="tab" id="tab-community"
           aria-controls="panel-community" aria-selected="false" tabindex="-1"
           data-tab="community">加入交流群</div>
    </nav>

    <!-- 反馈卡片 -->
    <section class="card" id="panel-feedback" role="tabpanel" aria-labelledby="tab-feedback" aria-hidden="false">
      <div class="row">
        <label for="fb-title">标题</label>
        <input id="fb-title" type="text" placeholder="简要描述你的问题或建议" />
      </div>
      <div class="row">
        <label for="fb-type">类型</label>
        <select id="fb-type">
          <option value="bug">缺陷/报错</option>
          <option value="feature">功能建议</option>
          <option value="uiux">交互/体验</option>
          <option value="other">其他</option>
        </select>
      </div>
      <div class="row">
        <label for="fb-content">详细描述</label>
        <textarea id="fb-content" placeholder="复现步骤 / 期望行为 / 实际结果 / 截图链接 …"></textarea>
      </div>
      <div class="row">
        <label>体验评分</label>
        <div class="stars" id="stars" aria-label="评分 1-5 星">
          <div class="star" role="radio" data-v="1">1</div>
          <div class="star" role="radio" data-v="2">2</div>
          <div class="star" role="radio" data-v="3">3</div>
          <div class="star" role="radio" data-v="4">4</div>
          <div class="star" role="radio" data-v="5">5</div>
        </div>
      </div>
      <div class="row">
        <label for="contact">可选联系方式</label>
        <input id="contact" type="text" placeholder="邮箱 / QQ" />
      </div>
      <div class="row">
        <label></label>
        <div>
          <label class="muted"><input id="sysinfo" type="checkbox" checked /> 附带浏览器与系统信息（便于排查）</label>
        </div>
      </div>

      <!-- App Store 评价 -->
      <div class="row" id="row-appstore" hidden>
        <label>App Store 评价</label>
        <div>
          <div class="btns">
            <a class="btn warn" id="btn-appstore-review">去 App Store 评价</a>
            <a class="btn" id="btn-appstore-copy">复制评价链接</a>
          </div>
          <div class="qr" style="margin-top:12px;">
            <div id="appstore-qr" class="qrbox" aria-label="App Store 评价二维码"></div>
            <div class="muted">用手机扫码直达“撰写评价”页。</div>
          </div>
        </div>
      </div>

      <div class="btns">
        <a class="btn primary" id="btn-issue" target="_blank" rel="noopener">通过 GitHub Issue 提交</a>
        <a class="btn" id="btn-mail">通过邮件提交</a>
        <button id="btn-copy-template">复制模板</button>
      </div>
      <p class="muted">提示：若 GitHub 需要登录，你也可以直接前往 App Store 评价或通过邮件反馈。</p>
    </section>

    <!-- 社群卡片（仅 QQ 群；无微信） -->
    <section class="card" id="panel-community" role="tabpanel" aria-labelledby="tab-community" hidden aria-hidden="true">
      <div class="grid">
        <!-- QQ 群 1 -->
        <div>
          <h3>QQ 群 1</h3>
          <div class="kvs">
            <input id="qq1-number" class="mono" type="text" readonly />
            <button data-copy="#qq1-number">复制群号</button>
          </div>
          <div class="btns" style="margin-top:10px;">
            <a class="btn success" id="btn-qq1-join" target="_blank" rel="noopener">一键加群</a>
            <a class="btn" id="btn-qq1-url-copy">复制加群链接</a>
          </div>
          <div class="qr" style="margin-top:12px;">
            <div id="qq1-qr" class="qrbox" aria-label="QQ群1 邀请二维码"></div>
            <div class="muted">此二维码由前端根据邀请链接实时生成。</div>
          </div>
        </div>

        <!-- QQ 群 2（已满） -->
        <div>
          <h3>QQ 群 2 <span class="badge full">已满</span></h3>
          <div class="kvs">
            <input id="qq2-number" class="mono" type="text" readonly />
            <button data-copy="#qq2-number">复制群号</button>
          </div>
          <div class="btns" style="margin-top:10px;">
            <a class="btn success disabled" id="btn-qq2-join" aria-disabled="true" tabindex="-1">一键加群（已满）</a>
            <a class="btn" id="btn-qq2-url-copy">复制加群链接</a>
          </div>
          <div class="qr" style="margin-top:12px;">
            <div id="qq2-qr" class="qrbox" aria-label="QQ群2 邀请二维码"></div>
            <div class="muted">此二维码由前端根据邀请链接实时生成。</div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      本页为静态页面，不收集任何敏感数据。提交内容将跳转到你配置的 Issue/邮箱处理。
    </footer>
  </div>

  <script>
    // ======== 1) 配置 ========
    const CONFIG = {
      // GitHub 仓库（用于 Issue）
      GH_OWNER: "timetrails-org",
      GH_REPO:  "timetrails-org.github.io",

      // 备用邮箱
      MAIL_TO:  "flywithbug@163.com",

      // QQ 群
      QQ1_NUMBER: "574966492",
      QQ1_INVITE_URL: "https://qm.qq.com/q/WmKwcZcZW",
      QQ2_NUMBER: "185198503",
      QQ2_INVITE_URL: "https://qm.qq.com/q/J1eYFA7i4m",
      QQ2_IS_FULL: true, // 已满

      // App Store（评价）
      IOS_APP_ID: "1634761411",
      IOS_APP_COUNTRY: "cn",   // 中国区

      // 仓库主页
      GH_HOMEPAGE: "https://github.com/timetrails-org/timetrails-org.github.io"
    };

    // ======== 2) 工具函数 ========
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function copyTextFrom(selector){
      const el = $(selector);
      if(!el) return;
      el.select?.();
      navigator.clipboard.writeText(el.value || el.textContent || '')
        .then(()=> alert('已复制到剪贴板'))
        .catch(()=> alert('复制失败，请手动复制'));
    }

    // A) 动态加载二维码库（多 CDN 轮询）
    async function loadQRCodeLib(){
      if (window.QRCode) return true;
      const srcs = [
        // 如需离线/国内稳定，优先把 qrcode.min.js 放到仓库并把第一项改成本地路径
        'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
        'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
      ];
      for (const src of srcs){
        try{
          await new Promise((resolve, reject)=>{
            const s = document.createElement('script');
            s.src = src; s.async = true; s.onload = resolve; s.onerror = reject;
            document.head.appendChild(s);
          });
          if (window.QRCode) {
            console.log('[QR] loaded from', src);
            return true;
          }
        }catch(e){
          console.warn('[QR] load failed:', src, e);
        }
      }
      console.error('[QR] 所有 CDN 加载失败。建议本地托管 qrcode.min.js');
      return false;
    }

    // B) 画二维码：优先 Canvas，失败回退 SVG
    async function drawQR(containerId, text, size = 180){
      const box = document.getElementById(containerId);
      if(!box){ console.error('[QR] 容器不存在:', containerId); return; }
      if(!text){ box.textContent = '无有效链接'; return; }

      const ok = await loadQRCodeLib();
      if(!ok){ box.textContent = '二维码库加载失败'; return; }

      box.innerHTML = '';
      try{
        const canvas = document.createElement('canvas');
        box.appendChild(canvas);
        await QRCode.toCanvas(canvas, text, { width:size, margin:1, errorCorrectionLevel:'M' });
        return;
      }catch(err){
        console.warn('[QR] Canvas 失败，回退 SVG:', err);
        box.innerHTML = '';
      }
      try{
        const svgStr = await QRCode.toString(text, { type:'svg', width:size, margin:1, errorCorrectionLevel:'M' });
        box.innerHTML = svgStr;
      }catch(err2){
        console.error('[QR] SVG 也失败:', err2);
        box.textContent = '二维码生成失败';
      }
    }

    // App Store 评价链接
    function getAppStoreReviewURLs(appId, country="cn"){
      if(!appId) return { web:"#", ios:"#"};
      const web = `https://apps.apple.com/${encodeURIComponent(country)}/app/id${encodeURIComponent(appId)}?action=write-review`;
      const ios = `itms-apps://itunes.apple.com/app/id${encodeURIComponent(appId)}?action=write-review`;
      return { web, ios };
    }
    function isIOSDevice(){
      const ua = navigator.userAgent || navigator.vendor || window.opera || "";
      return /iPad|iPhone|iPod/.test(ua) || (navigator.platform && /iP(hone|od|ad)/.test(navigator.platform));
    }

    // ======== 3) Tab（无障碍 + 键盘 + URL 同步；默认提交反馈） ========
    const tablist = document.querySelector('.tabs[role="tablist"]');
    const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
    const panels = tabs.map(t => document.getElementById(t.getAttribute('aria-controls')));

    function setSelected(index, { focus = false } = {}) {
      tabs.forEach((t, i) => {
        const selected = i === index;
        t.setAttribute('aria-selected', String(selected));
        t.tabIndex = selected ? 0 : -1;
        panels[i].hidden = !selected;
        panels[i].setAttribute('aria-hidden', String(!selected));
      });
      if (focus) tabs[index].focus();
      const key = tabs[index].dataset.tab;
      try{
        const url = new URL(location.href);
        url.searchParams.set('tab', key);
        history.replaceState(null, '', url.toString());
      }catch{}
    }
    function selectByKey(key, opts){ const idx = tabs.findIndex(t => t.dataset.tab === key); setSelected(idx >= 0 ? idx : 0, opts); }

    tabs.forEach((t, i) => t.addEventListener('click', () => setSelected(i, { focus:true })));
    tablist.addEventListener('keydown', (e) => {
      const current = tabs.findIndex(t => t === document.activeElement);
      if (current < 0) return;
      let next = null;
      switch (e.key) {
        case 'ArrowRight': next = (current + 1) % tabs.length; break;
        case 'ArrowLeft':  next = (current - 1 + tabs.length) % tabs.length; break;
        case 'Home':       next = 0; break;
        case 'End':        next = tabs.length - 1; break;
        case 'Enter':
        case ' ':
          setSelected(current, { focus:true });
          e.preventDefault();
          return;
        default: return;
      }
      tabs[next].focus();
      e.preventDefault();
    });

    // —— 默认“提交反馈”；仅当 ?tab=community 时切社群 —— //
    (function initTabs(){
      const url = new URL(location.href);
      const q = url.searchParams.get('tab');
      const key = (q === 'community') ? 'community' : 'feedback';
      selectByKey(key, { focus:false });
    })();

    // ======== 4) 初始化仓库/按钮/QQ群/评价 ========
    // 仓库
    $('#ghLink').href = CONFIG.GH_HOMEPAGE;
    $('#ghLink').textContent = '仓库主页';

    $$('button[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=> copyTextFrom(btn.getAttribute('data-copy')));
    });

    // QQ 群 1
    $('#qq1-number').value = CONFIG.QQ1_NUMBER || '';
    $('#btn-qq1-join').href = CONFIG.QQ1_INVITE_URL || '#';
    $('#btn-qq1-url-copy').addEventListener('click', ()=>{
      if(!CONFIG.QQ1_INVITE_URL){ alert('请先在代码中配置 QQ1_INVITE_URL'); return; }
      navigator.clipboard.writeText(CONFIG.QQ1_INVITE_URL).then(()=> alert('已复制加群链接'));
    });
    drawQR('qq1-qr', CONFIG.QQ1_INVITE_URL, 180);

    // QQ 群 2（已满）
    $('#qq2-number').value = CONFIG.QQ2_NUMBER || '';
    const join2 = $('#btn-qq2-join');
    if(CONFIG.QQ2_IS_FULL){
      join2.classList.add('disabled');
      join2.setAttribute('aria-disabled','true');
      join2.removeAttribute('href');
      join2.title = '该群已满';
    }else{
      join2.href = CONFIG.QQ2_INVITE_URL || '#';
    }
    $('#btn-qq2-url-copy').addEventListener('click', ()=>{
      if(!CONFIG.QQ2_INVITE_URL){ alert('请先在代码中配置 QQ2_INVITE_URL'); return; }
      navigator.clipboard.writeText(CONFIG.QQ2_INVITE_URL).then(()=> alert('已复制加群链接'));
    });
    drawQR('qq2-qr', CONFIG.QQ2_INVITE_URL, 180);

    // App Store 评价（如果配置了 APP ID 则显示）
    (function initAppStoreReview(){
      const row = $('#row-appstore');
      const appId = (CONFIG.IOS_APP_ID || '').trim();
      if(!appId){ row.hidden = true; return; }
      row.hidden = false;

      const { web, ios } = getAppStoreReviewURLs(appId, CONFIG.IOS_APP_COUNTRY || 'cn');

      // 评价按钮：iOS 走 itms-apps，其它走 web
      $('#btn-appstore-review').addEventListener('click', ()=>{
        const url = isIOSDevice() ? ios : web;
        window.location.href = url;
      });

      // 复制链接（统一复制 web 链接）
      $('#btn-appstore-copy').addEventListener('click', ()=>{
        navigator.clipboard.writeText(web)
          .then(()=> alert('已复制 App Store 评价链接'))
          .catch(()=> alert('复制失败，请手动复制'));
      });

      // 生成二维码（指向 web 链接）
      drawQR('appstore-qr', web, 180);
    })();

    // ======== 5) 反馈模板与提交 ========
    const titleEl = $('#fb-title');
    const typeEl = $('#fb-type');
    const contentEl = $('#fb-content');
    const contactEl = $('#contact');
    const sysinfoEl = $('#sysinfo');

    // 评分
    let starsValue = 0;
    const stars = $$('#stars .star');
    stars.forEach(s=>{
      s.addEventListener('click', ()=>{
        starsValue = Number(s.dataset.v);
        stars.forEach(x=> x.setAttribute('aria-checked', Number(x.dataset.v) <= starsValue));
      });
    });

    function getSystemInfo(){
      return [
        `UA: ${navigator.userAgent}`,
        `平台: ${navigator.platform}`,
        `语言: ${navigator.language}`,
        `屏幕: ${window.screen.width}x${window.screen.height} @${window.devicePixelRatio}`
      ].join('\n');
    }

    function buildMarkdown(){
      const lines = [];
      const t = titleEl.value.trim() || '(待补充标题)';
      lines.push(`### 描述`);
      lines.push(contentEl.value.trim() || '(详细描述/复现步骤/期望行为...)');
      lines.push('\n### 类型');
      lines.push(typeEl.value);
      lines.push('\n### 评分');
      lines.push(starsValue ? `${'★'.repeat(starsValue)} (${starsValue}/5)` : '未评分');
      lines.push('\n### 联系方式');
      lines.push(contactEl.value.trim() || '未提供');
      if(sysinfoEl.checked){
        lines.push('\n### 系统信息');
        lines.push('```');
        lines.push(getSystemInfo());
        lines.push('```');
      }
      return { title: t, body: lines.join('\n') };
    }

    function buildIssueURL(){
      if(!CONFIG.GH_OWNER || !CONFIG.GH_REPO){
        alert('请在代码中配置 GH_OWNER/GH_REPO');
        return '#';
      }
      const { title, body } = buildMarkdown();
      const base = `https://github.com/${CONFIG.GH_OWNER}/${CONFIG.GH_REPO}/issues/new`;
      return `${base}?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
    }

    function buildMailto(){
      if(!CONFIG.MAIL_TO){
        alert('请先在代码中配置 MAIL_TO');
        return '#';
      }
      const { title, body } = buildMarkdown();
      return `mailto:${CONFIG.MAIL_TO}?subject=${encodeURIComponent('[反馈] ' + title)}&body=${encodeURIComponent(body)}`;
    }

    $('#btn-issue').addEventListener('click', (e)=>{
      const url = buildIssueURL();
      e.currentTarget.href = url;
    });
    $('#btn-mail').addEventListener('click', (e)=>{
      const url = buildMailto();
      e.currentTarget.href = url;
      window.location.href = url;
    });
    $('#btn-copy-template').addEventListener('click', ()=>{
      const { title, body } = buildMarkdown();
      const all = `# ${title}\n\n${body}`;
      navigator.clipboard.writeText(all).then(()=> alert('已复制反馈模板，粘贴到任意渠道即可')).catch(()=> alert('复制失败'));
    });
  </script>
</body>
</html>
