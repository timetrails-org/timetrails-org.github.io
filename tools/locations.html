<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>轨迹预览（基础版：时间+坐标）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map { width:100%; height:100%; margin:0; padding:0; background:#0f1117; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif; }
    .panel {
      position:absolute; z-index:9999; left:12px; top:12px; background:rgba(15,15,15,0.7);
      border-radius:12px; padding:10px 14px; box-shadow:0 12px 32px rgba(0,0,0,0.6);
      font-size:13px; line-height:1.4; max-width:360px; backdrop-filter:blur(8px); color:#eee; user-select:none;
      transition:transform .22s ease, opacity .22s ease, max-height .22s ease;
    }
    .panel b { color:#fff; font-weight:600; font-size:13px; }
    .panel-header { display:flex; align-items:center; gap:8px; }
    .panel-title { display:flex; align-items:center; gap:8px; min-width:0; }
    .mini { font-size:11px; color:#9aa4af; padding:2px 6px; border-radius:999px; border:1px solid #2b3138; background:rgba(0,0,0,.25); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; }
    .toggle { margin-left:auto; border:1px solid #30363d; background:#11141a; color:#e6edf3; border-radius:8px; padding:4px 8px; cursor:pointer; font-size:12px; }
    .toggle:hover { background:#171b22; }
    .content { margin-top:8px; }
    .row { margin-top:8px; display:grid; gap:6px; }
    .row label { font-size:12px; color:#bbb; }
    .row input[type="datetime-local"]{ width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #30363d; background:#0b0d12; color:#e6edf3; padding:6px 8px; }
    .btns { display:flex; gap:8px; margin-top:6px; }
    .btns button, .btns label.btn { flex:1; border:1px solid #30363d; background:#11141a; color:#e6edf3; border-radius:8px; padding:6px 10px; cursor:pointer; text-align:center; }
    .btns button:hover, .btns label.btn:hover { background:#171b22; }
    .muted { color:#aaa; }
    .dropzone { margin-top:8px; border:1px dashed #3a3f44; border-radius:10px; padding:8px; text-align:center; font-size:12px; color:#c9d1d9; background:rgba(13,15,22,0.5); transition:background .2s, border-color .2s; }
    .dropzone.dragover { border-color:#58a6ff; background:rgba(13,15,22,0.8); }
    .fileok { color:#59f; font-size:12px; word-break:break-all; }
    .error { color:#ff6b6b; font-size:12px; white-space:pre-wrap; }
    code { background:#0b0d12; padding:1px 4px; border-radius:4px; }
    .panel.collapsed { padding:8px 10px; max-height:48px; overflow:hidden; }
    .panel.collapsed .content { display:none; }
  </style>

  <!-- 百度地图 WebGL API（替换 ak 为你的） -->
  <script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=sUryxWWxRyHZxuzB634wHfmlqy6RgMEy"></script>
  <!-- sql.js（SQLite WASM） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>

  <!-- 默认内联数据（可为空数组；页面初载会读取这里） -->
  <script id="trackData" type="application/json">[]</script>
</head>
<body>
  <div id="map"></div>

  <div class="panel" id="infoPanel">
    <div class="panel-header">
      <div class="panel-title">
        <b>轨迹点预览（基础）</b>
        <span id="miniStats" class="mini">—</span>
      </div>
      <button id="togglePanel" class="toggle" aria-expanded="true" title="折叠/展开（快捷键：P）">收起</button>
    </div>

    <div class="content">
      <div class="row">
        <label>数据来源：</label>
        <div class="btns">
          <label class="btn" for="fileInput">选择文件（.json / .db / .sqlite）</label>
        </div>
        <input id="fileInput" type="file" accept=".json,application/json,.db,.sqlite,application/octet-stream" style="display:none" />
        <div class="dropzone" id="dropzone">拖拽 JSON 或 SQLite DB 文件到这里加载</div>
        <div class="muted">
          JSON 支持：<code>timestamp / timeString / ts</code> 与 <code>longitude|lon / latitude|lat</code>（或 <code>lon_e6 / lat_e6</code>）；<br />
          SQLite：至少包含时间/经度/纬度列，常见别名会自动识别。
        </div>
        <div id="fileStatus" class="fileok" style="display:none;"></div>
        <div id="fileError" class="error" style="display:none;"></div>
      </div>

      <div class="row">
        <label>时间片段（本地时区）：</label>
        <input id="startInput" type="datetime-local" step="1" />
        <input id="endInput" type="datetime-local" step="1" />
        <div class="btns">
          <button id="applyBtn">应用筛选</button>
          <button id="resetBtn" title="重置为全量区间">重置</button>
        </div>
      </div>

      <div class="row">
        <div id="statsCount">点数：-</div>
        <div id="statsRange">时间范围：-</div>
        <div class="muted">说明：仅使用时间与坐标；坐标系自动识别 WGS84/GCJ-02 → BD09</div>
      </div>
    </div>
  </div>

  <script>
    /************ 坐标转换 ************/
    function _outOfChina(lng, lat){return(lng<72.004||lng>137.8347||lat<0.8293||lat>55.8271);}
    function _transformLat(lng,lat){let ret=-100+2*lng+3*lat+0.2*lat*lat+0.1*lng*lat+0.2*Math.sqrt(Math.abs(lng));ret+=(20*Math.sin(6*lng*Math.PI)+20*Math.sin(2*lng*Math.PI))*2/3;ret+=(20*Math.sin(lat*Math.PI)+40*Math.sin(lat/3*Math.PI))*2/3;ret+=(160*Math.sin(lat/12*Math.PI)+320*Math.sin(lat*Math.PI/30))*2/3;return ret;}
    function _transformLng(lng,lat){let ret=300+lng+2*lat+0.1*lng*lng+0.1*lng*lat+0.1*Math.sqrt(Math.abs(lng));ret+=(20*Math.sin(6*lng*Math.PI)+20*Math.sin(2*lng*Math.PI))*2/3;ret+=(20*Math.sin(lng*Math.PI)+40*Math.sin(lng/3*Math.PI))*2/3;ret+=(150*Math.sin(lng/12*Math.PI)+300*Math.sin(lng/30*Math.PI))*2/3;return ret;}
    function wgs84ToGcj02(lng,lat){ if(_outOfChina(lng,lat)) return [lng,lat]; const a=6378245.0,ee=0.00669342162296594323; let dLat=_transformLat(lng-105,lat-35), dLng=_transformLng(lng-105,lat-35); const radLat=lat/180*Math.PI; let magic=Math.sin(radLat); magic=1-ee*magic*magic; const sqrtMagic=Math.sqrt(magic); dLat=(dLat*180)/((a*(1-ee))/(magic*sqrtMagic)*Math.PI); dLng=(dLng*180)/(a/sqrtMagic*Math.cos(radLat)*Math.PI); return [lng+dLng, lat+dLat];}
    function gcj02ToBd09(lng,lat){const x=lng,y=lat; const z=Math.sqrt(x*x+y*y)+0.00002*Math.sin(y*Math.PI*3000/180); const th=Math.atan2(y,x)+0.000003*Math.cos(x*Math.PI*3000/180); return [z*Math.cos(th)+0.0065, z*Math.sin(th)+0.006];}
    function wgs84ToBd09(lng,lat){const [glng,glat]=wgs84ToGcj02(lng,lat); return gcj02ToBd09(glng,glat);}

    /************ 小工具 ************/
    const pad2=n=>n<10?('0'+n):''+n;
    function tsToLocal(ts){const d=new Date(ts);return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;}
    function tsToLocalInput(ts){const d=new Date(ts);return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;}
    function inputToTs(val){ if(!val) return null; const t=new Date(val).getTime(); return Number.isFinite(t)?t:null; }
    function normTs(x){const n=Number(x); return n<1e12?n*1000:n;}

    /************ 兼容解析（仅保留 时间+坐标）************/
    function parseTsFlexible(p){
      if (Number.isFinite(p.ts)) return p.ts<1e12?p.ts*1000:p.ts;
      if (Number.isFinite(p.timestamp)) return p.timestamp<1e12?p.timestamp*1000:p.timestamp;
      if (p.timeString){ const d=new Date(p.timeString.replace(" ","T")); const t=d.getTime(); if(Number.isFinite(t)) return t; }
      return NaN;
    }
    function pickDegFlexible(p){
      // 优先 WGS 字段
      if (Number.isFinite(p.latitude) && Number.isFinite(p.longitude)) return {lng:+p.longitude, lat:+p.latitude, gcj:false};
      // 若仅有 GCJ 字段
      if (Number.isFinite(p.gcj02latitude) && Number.isFinite(p.gcj02longitude)) return {lng:+p.gcj02longitude, lat:+p.gcj02latitude, gcj:true};
      // 已是 e6
      if (Number.isFinite(p.lon_e6) && Number.isFinite(p.lat_e6)) return {lng:p.lon_e6/1e6, lat:p.lat_e6/1e6, gcj:false};
      // 其他常见命名
      if (Number.isFinite(p.lat) && Number.isFinite(p.lon)) return {lng:+p.lon, lat:+p.lat, gcj:false};
      return null;
    }
    const toE6 = x => Math.round(x * 1e6);

    /************ 全局状态 ************/
    let map=null;
    let rawTrack=[]; // 仅 { ts, lon_e6, lat_e6, __gcj? }
    let minTs=null, maxTs=null;
    window.__TT_SQLDB__=null; // { db, table, tsCol, lonCol, latCol, optCols }

    /************ 渲染 ************/
    function buildPoints(raw){
      const pts=[];
      for (const p of raw){
        const lng=p.lon_e6/1e6, lat=p.lat_e6/1e6;
        let bdLng, bdLat;
        if (p.__gcj===true){ [bdLng,bdLat]=gcj02ToBd09(lng,lat); }
        else { [bdLng,bdLat]=wgs84ToBd09(lng,lat); }
        pts.push({ point:new BMapGL.Point(bdLng,bdLat), data:p });
      }
      return pts;
    }

    function renderMarkers(filtered){
      map.clearOverlays();
      if (filtered.length===0){
        map.centerAndZoom(new BMapGL.Point(116.404,39.915),12);
        document.getElementById("statsCount").textContent=`点数：0`;
        document.getElementById("statsRange").textContent=`时间范围：-`;
        document.getElementById("miniStats").textContent=`0 · —`;
        return;
      }
      map.setViewport(filtered.map(x=>x.point));

      for (let i=0;i<filtered.length;i++){
        const { point, data } = filtered[i];
        const marker=new BMapGL.Marker(point);
        marker.setTitle(`#${i}\n时间: ${tsToLocal(data.ts)}`);
        map.addOverlay(marker);
      }
      // 起终点
      if (filtered.length>=1){
        const first=filtered[0].point;
        const startMarker=new BMapGL.Marker(first);
        startMarker.setTitle("起点");
        const startLabel=new BMapGL.Label("起点",{position:first,offset:new BMapGL.Size(10,-20)});
        startLabel.setStyle({color:"#00E0FF",backgroundColor:"rgba(0,0,0,0.6)",border:"1px solid #00E0FF",borderRadius:"6px",padding:"2px 4px",fontSize:"12px",lineHeight:"14px"});
        map.addOverlay(startMarker); map.addOverlay(startLabel);
      }
      if (filtered.length>=2){
        const last=filtered[filtered.length-1].point;
        const endMarker=new BMapGL.Marker(last);
        endMarker.setTitle("终点");
        const endLabel=new BMapGL.Label("终点",{position:last,offset:new BMapGL.Size(10,-20)});
        endLabel.setStyle({color:"#FF4D4F",backgroundColor:"rgba(0,0,0,0.6)",border:"1px solid #FF4D4F",borderRadius:"6px",padding:"2px 4px",fontSize:"12px",lineHeight:"14px"});
        map.addOverlay(endMarker); map.addOverlay(endLabel);
      }
    }

    function applyFilter_JSON(){
      const sTs=inputToTs(document.getElementById("startInput").value);
      const eTs=inputToTs(document.getElementById("endInput").value);
      const s=(sTs==null)?minTs:sTs;
      const e=(eTs==null)?maxTs:eTs;
      if (s>e){ alert("起始时间不可晚于结束时间"); return; }

      const arr=rawTrack.filter(p=>p.ts>=s&&p.ts<=e);
      renderMarkers(buildPoints(arr));

      const count=arr.length;
      const startTxt=(count>0)?tsToLocal(arr[0].ts):"-";
      const endTxt=(count>0)?tsToLocal(arr[count-1].ts):"-";
      document.getElementById("statsCount").textContent=`点数：${count}`;
      document.getElementById("statsRange").textContent=`时间范围：${startTxt} → ${endTxt}`;
      document.getElementById("miniStats").textContent=`${count} · ${startTxt} → ${endTxt}`;
    }

    function applyFilter_DB(){
      const sess=window.__TT_SQLDB__;
      if (!sess){ applyFilter_JSON(); return; }

      const sTs=inputToTs(document.getElementById("startInput").value);
      const eTs=inputToTs(document.getElementById("endInput").value);
      const s=(sTs==null)?minTs:sTs;
      const e=(eTs==null)?maxTs:eTs;
      if (s>e){ alert("起始时间不可晚于结束时间"); return; }

      const { db, table, tsCol, lonCol, latCol } = sess;
      const sql=`SELECT ${tsCol} AS _ts, ${lonCol} AS _lon, ${latCol} AS _lat, gcj02latitude AS _gclat, gcj02longitude AS _gclon
                 FROM ${table} WHERE ${tsCol} BETWEEN ? AND ? ORDER BY ${tsCol} ASC;`;
      const res=db.exec(sql,[Math.floor(s),Math.floor(e)]);
      if (!res||res.length===0){
        renderMarkers([]); document.getElementById("statsCount").textContent=`点数：0`;
        document.getElementById("statsRange").textContent=`时间范围：-`; document.getElementById("miniStats").textContent=`0 · —`; return;
      }
      const cols=res[0].columns, rows=res[0].values;
      const arr=rows.map(row=>{
        const r={}; for (let i=0;i<cols.length;i++) r[cols[i]]=row[i];
        const ts=normTs(r._ts);
        const lon=Number(r._lon), lat=Number(r._lat);
        const looksDeg=Number.isFinite(lon)&&Number.isFinite(lat)&&Math.abs(lon)<=180&&Math.abs(lat)<=90;
        const lon_e6=looksDeg?Math.round(lon*1e6):Math.round(lon);
        const lat_e6=looksDeg?Math.round(lat*1e6):Math.round(lat);
        const gcj = Number.isFinite(r._gclat)&&Number.isFinite(r._gclon); // 若表含 gcj02 字段，则视为 GCJ
        return { ts, lon_e6, lat_e6, __gcj: gcj };
      });

      renderMarkers(buildPoints(arr));
      const count=arr.length;
      const startTxt=(count>0)?tsToLocal(arr[0].ts):"-";
      const endTxt=(count>0)?tsToLocal(arr[count-1].ts):"-";
      document.getElementById("statsCount").textContent=`点数：${count}`;
      document.getElementById("statsRange").textContent=`时间范围：${startTxt} → ${endTxt}`;
      document.getElementById("miniStats").textContent=`${count} · ${startTxt} → ${endTxt}`;
    }

    function applyFilter(){ if (window.__TT_SQLDB__) applyFilter_DB(); else applyFilter_JSON(); }
    function resetRange(){ document.getElementById("startInput").value=tsToLocalInput(minTs); document.getElementById("endInput").value=tsToLocalInput(maxTs); applyFilter(); }

    /************ 数据加载（仅保留时间+坐标）************/
    function setTrackData(arr, sourceLabel="内联/JSON"){
      window.__TT_SQLDB__=null;
      if (!Array.isArray(arr)) throw new Error("JSON 顶层必须是数组");

      const cleaned=[];
      for (const p of arr){
        const ts=parseTsFlexible(p);
        const deg=pickDegFlexible(p);
        if (!Number.isFinite(ts) || !deg) continue;
        cleaned.push({ ts: (ts<1e12?ts*1000:ts), lon_e6: Math.round(deg.lng*1e6), lat_e6: Math.round(deg.lat*1e6), __gcj: !!deg.gcj });
      }

      cleaned.sort((a,b)=>a.ts-b.ts);
      if (cleaned.length>0){ minTs=cleaned[0].ts; maxTs=cleaned[cleaned.length-1].ts; }
      else { const now=Date.now(); minTs=now-3600_000; maxTs=now; }

      const fileStatus=document.getElementById("fileStatus");
      fileStatus.style.display="block";
      fileStatus.textContent=`已加载（${sourceLabel}）：${cleaned.length} 条`;
      document.getElementById("fileError").style.display="none";

      const s=document.getElementById("startInput"), e=document.getElementById("endInput");
      s.min=tsToLocalInput(minTs); s.max=tsToLocalInput(maxTs);
      e.min=tsToLocalInput(minTs); e.max=tsToLocalInput(maxTs);
      s.value=tsToLocalInput(minTs); e.value=tsToLocalInput(maxTs);

      rawTrack=cleaned;
      applyFilter();
    }

    function loadFromInlineScript(){
      const node=document.getElementById('trackData');
      const rawText=node.textContent.trim();
      try{ setTrackData(JSON.parse(rawText||"[]"), "内联 trackData"); }
      catch(e){ const fe=document.getElementById("fileError"); fe.style.display="block"; fe.textContent=`内联 JSON 解析失败：${e.message}`; }
    }

    // sql.js init once
    let SQL_INIT_PROMISE=null;
    function initSqlJsOnce(){
      if (!SQL_INIT_PROMISE){
        SQL_INIT_PROMISE=initSqlJs({ locateFile:file=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${file}` });
      }
      return SQL_INIT_PROMISE;
    }

    async function loadFromSQLite(file){
      const fileError=document.getElementById("fileError");
      const fileStatus=document.getElementById("fileStatus");
      fileError.style.display="none"; fileStatus.style.display="none";
      try{
        const SQL=await initSqlJsOnce();
        const buf=new Uint8Array(await file.arrayBuffer());
        const db=new SQL.Database(buf);
        const tables=db.exec(`SELECT name FROM sqlite_master WHERE type='table'`)?.flatMap(r=>r.values.map(v=>String(v[0])))||[];
        const prefer=["location","Location","locations"];
        let candidate=prefer.find(n=>tables.includes(n))||null;

        function tableInfo(name){ return db.exec(`PRAGMA table_info(${JSON.stringify(name)})`); }
        function colSet(info){ return new Set(info[0]?.values?.map(v=>String(v[1]))||[]); }
        function pickOne(names,cands){ for (const c of cands) if (names.has(c)) return c; return null; }

        const need = {
          ts : ["ts","timestamp","time_ms","time","ts_ms","created_at","recorded_at"],
          lon: ["lon_e6","longitude_e6","lon_e7","longitude_e7","lon","longitude","lng"],
          lat: ["lat_e6","latitude_e6","lat_e7","latitude_e7","lat","latitude"]
        };

        function findTable(){
          const tryOne=(t)=>{ const info=tableInfo(t); if(!info||info.length===0) return null;
            const names=colSet(info);
            const tsCol=pickOne(names,need.ts), lonCol=pickOne(names,need.lon), latCol=pickOne(names,need.lat);
            return (tsCol&&lonCol&&latCol)?{table:t,names,tsCol,lonCol,latCol}:null; };
          if (candidate){ const r=tryOne(candidate); if (r) return r; }
          for (const t of tables){ const r=tryOne(t); if (r) return r; }
          return null;
        }

        const found=findTable();
        if (!found) throw new Error("未找到同时包含时间/经度/纬度关键列的表（例如 location）");

        const { table, tsCol, lonCol, latCol } = found;

        // 预读时间范围
        const mm=db.exec(`SELECT MIN(${tsCol}) AS min_ts, MAX(${tsCol}) AS max_ts FROM ${table};`);
        const row=mm[0]?.values?.[0]||[];
        minTs=normTs(row[0]); maxTs=normTs(row[1]);
        if (!Number.isFinite(minTs)||!Number.isFinite(maxTs)) throw new Error("无法读取 MIN/MAX(ts)");

        window.__TT_SQLDB__={ db, table, tsCol, lonCol, latCol };

        const s=document.getElementById("startInput"), e=document.getElementById("endInput");
        s.min=tsToLocalInput(minTs); s.max=tsToLocalInput(maxTs);
        e.min=tsToLocalInput(minTs); e.max=tsToLocalInput(maxTs);
        s.value=tsToLocalInput(minTs); e.value=tsToLocalInput(maxTs);

        document.getElementById("fileStatus").style.display="block";
        document.getElementById("fileStatus").textContent=`已连接 SQLite（${file.name} / 表：${table}）`;

        applyFilter_DB();
      }catch(e){
        fileError.style.display="block";
        fileError.textContent=`SQLite 解析失败：${e.message}`;
        window.__TT_SQLDB__=null;
      }
    }

    async function loadFromFile(file){
      const name=(file?.name||"").toLowerCase();
      if (name.endsWith(".json")){
        try{ setTrackData(JSON.parse(await file.text()), file.name); }
        catch(e){ const fe=document.getElementById("fileError"); fe.style.display="block"; fe.textContent=`JSON 解析失败：${e.message}`; }
      } else if (name.endsWith(".db") || name.endsWith(".sqlite")){
        await loadFromSQLite(file);
      } else {
        await loadFromSQLite(file);
      }
    }

    /************ 面板与初始化 ************/
    function setPanelCollapsed(collapsed){
      const panel=document.getElementById("infoPanel");
      const btn=document.getElementById("togglePanel");
      if (collapsed){ panel.classList.add("collapsed"); btn.textContent="展开"; btn.setAttribute("aria-expanded","false"); localStorage.setItem("tt_panel_collapsed","1"); }
      else { panel.classList.remove("collapsed"); btn.textContent="收起"; btn.setAttribute("aria-expanded","true"); localStorage.setItem("tt_panel_collapsed","0"); }
    }

    function init(){
      map=new BMapGL.Map("map",{ enableRotate:false, enableTilt:false });
      map.centerAndZoom(new BMapGL.Point(116.404,39.915),12);
      map.addControl(new BMapGL.ZoomControl());
      map.enableScrollWheelZoom(true);

      setPanelCollapsed(localStorage.getItem("tt_panel_collapsed")==="1");
      document.getElementById("togglePanel").addEventListener("click",()=>setPanelCollapsed(!document.getElementById("infoPanel").classList.contains("collapsed")));
      document.querySelector(".panel-header").addEventListener("dblclick",()=>setPanelCollapsed(!document.getElementById("infoPanel").classList.contains("collapsed")));
      window.addEventListener("keydown",(e)=>{ if(e.key.toLowerCase()==="p"&&!e.repeat) setPanelCollapsed(!document.getElementById("infoPanel").classList.contains("collapsed")); });

      document.getElementById("applyBtn").addEventListener("click",applyFilter);
      document.getElementById("resetBtn").addEventListener("click",resetRange);
      document.getElementById("startInput").addEventListener("change",applyFilter);
      document.getElementById("endInput").addEventListener("change",applyFilter);

      document.getElementById("fileInput").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if (f) loadFromFile(f); });
      const dz=document.getElementById("dropzone");
      const prevent=ev=>{ ev.preventDefault(); ev.stopPropagation(); };
      ["dragenter","dragover","dragleave","drop"].forEach(evt=>dz.addEventListener(evt,prevent,false));
      ["dragenter","dragover"].forEach(()=>dz.classList.add("dragover"));
      ["dragleave","drop"].forEach(()=>dz.classList.remove("dragover"));
      dz.addEventListener("drop",(ev)=>{ const f=ev.dataTransfer.files?.[0]; if (f) loadFromFile(f); });

      loadFromInlineScript();
    }
    init();
  </script>
</body>
</html>
