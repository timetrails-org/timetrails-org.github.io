<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>轨迹预览（时间+坐标；只画点，海量点自适应 | 支持 CSV/GPX/KML）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body, #map { width:100%; height:100%; margin:0; padding:0; background:#0f1117; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif; }
    .panel { position:absolute; z-index:9999; left:12px; top:12px; background:rgba(15,15,15,0.7); border-radius:12px; padding:10px 14px; box-shadow:0 12px 32px rgba(0,0,0,0.6); font-size:13px; line-height:1.4; max-width:360px; backdrop-filter:blur(8px); color:#eee; user-select:none; transition:transform .22s ease, opacity .22s ease, max-height .22s ease; }
    .panel b { color:#fff; font-weight:600; font-size:13px; }
    .panel-header { display:flex; align-items:center; gap:8px; }
    .panel-title { display:flex; align-items:center; gap:8px; min-width:0; }
    .mini { font-size:11px; color:#9aa4af; padding:2px 6px; border-radius:999px; border:1px solid #2b3138; background:rgba(0,0,0,.25); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px; }
    .toggle { margin-left:auto; border:1px solid #30363d; background:#11141a; color:#e6edf3; border-radius:8px; padding:4px 8px; cursor:pointer; font-size:12px; }
    .toggle:hover { background:#171b22; }
    .content { margin-top:8px; }
    .row { margin-top:8px; display:grid; gap:6px; }
    .row input[type="datetime-local"]{ width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #30363d; background:#0b0d12; color:#e6edf3; padding:6px 8px; }
    .btns { display:flex; gap:8px; margin-top:6px; }
    .btns button, .btns label.btn { flex:1; border:1px solid #30363d; background:#11141a; color:#e6edf3; border-radius:8px; padding:6px 10px; cursor:pointer; text-align:center; }
    .btns button:hover, .btns label.btn:hover { background:#171b22; }
    .muted { color:#aaa; }
    .dropzone { margin-top:8px; border:1px dashed #3a3f44; border-radius:10px; padding:8px; text-align:center; font-size:12px; color:#c9d1d9; background:rgba(13,15,22,0.5); transition:background .2s, border-color .2s; }
    .dropzone.dragover { border-color:#58a6ff; background:rgba(13,15,22,0.8); }
    .fileok { color:#59f; font-size:12px; word-break:break-all; }
    .error { color:#ff6b6b; font-size:12px; white-space:pre-wrap; }
    .loading { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.35); z-index: 99999; backdrop-filter: blur(2px); }
    .loading.show { display: flex; }
    .spinner { width: 56px; height: 56px; border-radius: 50%; border: 6px solid rgba(255,255,255,0.2); border-top-color: #58a6ff; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { margin-top: 12px; color: #c9d1d9; font-size: 12px; text-align: center; }
  </style>

  <!-- 百度地图 WebGL API（替换 ak 为你的） -->
  <script src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=sUryxWWxRyHZxuzB634wHfmlqy6RgMEy"></script>
  <!-- sql.js（SQLite WASM） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>

  <!-- 默认内联数据 -->
  <script id="trackData" type="application/json">[]</script>
</head>
<body>
  <div id="map"></div>

  <div class="panel" id="infoPanel">
    <div class="panel-header">
      <div class="panel-title">
        <b>轨迹点预览（只画点）</b>
        <span id="miniStats" class="mini">—</span>
      </div>
      <button id="togglePanel" class="toggle" aria-expanded="true">收起</button>
    </div>

    <div class="content">
      <div class="row">
        <div class="btns">
          <label class="btn" for="fileInput">选择文件（.json / .db / .sqlite / .csv / .gpx / .kml）</label>
        </div>
        <input id="fileInput" type="file"
               accept=".json,application/json,.db,.sqlite,application/octet-stream,.csv,text/csv,.gpx,application/gpx+xml,.kml,application/vnd.google-earth.kml+xml"
               style="display:none" />
        <div class="dropzone" id="dropzone">拖拽 JSON / SQLite / CSV / GPX / KML 文件到这里加载</div>
        <div class="muted">
          JSON/CSV：列包含 <code>timestamp/time/ts/timeString</code> 与 <code>longitude|lon / latitude|lat</code>（或 <code>lon_e6 / lat_e6</code>）；<br/>
          GPX：读取 <code>&lt;trkpt lat="…" lon="…"&gt;&lt;time&gt;…&lt;/time&gt;</code> 与 <code>&lt;wpt&gt;</code>；<br/>
          KML：读取 <code>gx:Track</code> 的 <code>when</code>/<code>gx:coord</code>，或 <code>LineString/Point.coordinates</code>；<br/>
          SQLite：至少包含 时间/经度/纬度；支持秒/毫秒识别；可选 <code>gcj02*</code>/<code>isMarsLocation</code>。
        </div>
        <div id="fileStatus" class="fileok" style="display:none;"></div>
        <div id="fileError" class="error" style="display:none;"></div>
      </div>

      <div class="row">
        <label>时间片段（本地时区）：</label>
        <input id="startInput" type="datetime-local" step="1" />
        <input id="endInput" type="datetime-local" step="1" />
        <div class="btns">
          <button id="applyBtn">应用筛选</button>
          <button id="resetBtn" title="重置为全量区间">重置</button>
        </div>
      </div>

      <div class="row">
        <div id="statsCount">点数：-</div>
        <div id="statsRange">时间范围：-</div>
        <div class="muted">小于 1000：Marker；≥1000：PointCollection；若不可用则回退 Canvas 海量点。</div>
      </div>
    </div>
  </div>

  <div id="loading" class="loading" aria-live="polite" aria-busy="true">
    <div>
      <div class="spinner"></div>
      <div id="loadingText" class="loading-text">加载中…</div>
    </div>
  </div>

  <script>
    /************ 实用：加载遮罩 ************/
    function showLoading(msg){ const el=document.getElementById("loading"); document.getElementById("loadingText").textContent=msg||"加载中…"; el.classList.add("show"); }
    function hideLoading(){ document.getElementById("loading").classList.remove("show"); }

    /************ 坐标转换 ************/
    function _outOfChina(lng, lat){return(lng<72.004||lng>137.8347||lat<0.8293||lat>55.8271);}
    function _transformLat(lng,lat){let ret=-100+2*lng+3*lat+0.2*lat*lat+0.1*lng*lat+0.2*Math.sqrt(Math.abs(lng));ret+=(20*Math.sin(6*lng*Math.PI)+20*Math.sin(2*lng*Math.PI))*2/3;ret+=(20*Math.sin(lat*Math.PI)+40*Math.sin(lat/3*Math.PI))*2/3;ret+=(160*Math.sin(lat/12*Math.PI)+320*Math.sin(lat*Math.PI/30))*2/3;return ret;}
    function _transformLng(lng,lat){let ret=300+lng+2*lat+0.1*lng*lng+0.1*lng*lat+0.1*Math.sqrt(Math.abs(lng));ret+=(20*Math.sin(6*lng*Math.PI)+20*Math.sin(2*lng*Math.PI))*2/3;ret+=(20*Math.sin(lng*Math.PI)+40*Math.sin(lng/3*Math.PI))*2/3;ret+=(150*Math.sin(lng/12*Math.PI)+300*Math.sin(lng/30*Math.PI))*2/3;return ret;}
    function wgs84ToGcj02(lng,lat){ if(_outOfChina(lng,lat)) return [lng,lat]; const a=6378245.0,ee=0.00669342162296594323; let dLat=_transformLat(lng-105,lat-35), dLng=_transformLng(lng-105,lat-35); const radLat=lat/180*Math.PI; let magic=Math.sin(radLat); magic=1-ee*magic*magic; const sqrtMagic=Math.sqrt(magic); dLat=(dLat*180)/((a*(1-ee))/(magic*sqrtMagic)*Math.PI); dLng=(dLng*180)/(a/sqrtMagic*Math.cos(radLat)*Math.PI); return [lng+dLng, lat+dLat];}
    function gcj02ToBd09(lng,lat){const x=lng,y=lat; const z=Math.sqrt(x*x+y*y)+0.00002*Math.sin(y*Math.PI*3000/180); const th=Math.atan2(y,x)+0.000003*Math.cos(x*Math.PI*3000/180); return [z*Math.cos(th)+0.0065, z*Math.sin(th)+0.006];}
    function wgs84ToBd09(lng,lat){const [glng,glat]=wgs84ToGcj02(lng,lat); return gcj02ToBd09(glng,glat);}

    /************ 小工具 ************/
    const pad2=n=>n<10?('0'+n):''+n;
    function tsToLocal(ts){const d=new Date(ts);return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;}
    function tsToLocalInput(ts){const d=new Date(ts);return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;}
    function inputToTs(val){ if(!val) return null; const t=new Date(val).getTime(); return Number.isFinite(t)?t:null; }
    const num = x => (x==null || x==="") ? NaN : Number(x);

    /************ 兼容解析：时间/坐标抽取（JSON/CSV/GPX/KML 通用）************/
    function parseTsFlexible(p){
      if (Number.isFinite(p.ts)) return p.ts<1e12?p.ts*1000:p.ts;
      if (Number.isFinite(p.timestamp)) return p.timestamp<1e12?p.timestamp*1000:p.timestamp;
      if (p.time_ms && Number.isFinite(p.time_ms)) return Number(p.time_ms);
      if (p.time && Number.isFinite(p.time)) return (p.time<1e12? p.time*1000 : p.time);
      if (typeof p.timeString === 'string'){ const d=new Date(p.timeString.replace(" ","T")); const t=d.getTime(); if(Number.isFinite(t)) return t; }
      if (typeof p.datetime === 'string'){ const t=new Date(p.datetime).getTime(); if (Number.isFinite(t)) return t; }
      if (typeof p.date === 'string'){ const t=new Date(p.date).getTime(); if (Number.isFinite(t)) return t; }
      return NaN;
    }
    function pickDegFlexible(p){
      if (Number.isFinite(p.latitude) && Number.isFinite(p.longitude)) return {lng:+p.longitude, lat:+p.latitude, gcj:false};
      if (Number.isFinite(p.gcj02latitude) && Number.isFinite(p.gcj02longitude)) return {lng:+p.gcj02longitude, lat:+p.gcj02latitude, gcj:true};
      if (Number.isFinite(p.lon_e6) && Number.isFinite(p.lat_e6)) return {lng:p.lon_e6/1e6, lat:p.lat_e6/1e6, gcj:false};
      if (Number.isFinite(p.lat) && Number.isFinite(p.lon)) return {lng:+p.lon, lat:+p.lat, gcj:false};
      if (Number.isFinite(p.lng) && Number.isFinite(p.lat)) return {lng:+p.lng, lat:+p.lat, gcj:false};
      return null;
    }

    /************ CSV 解析 ************/
    function splitCSVLine(line){
      const out=[]; let cur=''; let inQ=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch==='\"'){
          if (inQ && line[i+1]==='\"'){ cur+='\"'; i++; }
          else inQ=!inQ;
        } else if (ch===',' && !inQ){
          out.push(cur); cur='';
        } else {
          cur+=ch;
        }
      }
      out.push(cur);
      return out.map(s=>s.trim());
    }
    function parseCSV(text){
      const lines=text.replace(/\r\n?/g,'\n').split('\n').filter(l=>l.trim().length>0);
      if (lines.length===0) return [];
      const header=splitCSVLine(lines[0]).map(h=>h.trim().toLowerCase());
      const idx = nameList=>{
        for (const n of nameList){
          const k=n.toLowerCase(); const j=header.indexOf(k);
          if (j>=0) return j;
        } return -1;
      };
      const tidx=idx(['timestamp','time_ms','time','ts','times','datetime','date','timeString'.toLowerCase()]);
      const lonIdx=idx(['longitude','lon','lng','lon_e6']);
      const latIdx=idx(['latitude','lat','lat_e6']);
      const gcjIdx=idx(['isMarsLocation','gcj','gcj02','is_gcj']);
      const out=[];
      for (let i=1;i<lines.length;i++){
        const cols=splitCSVLine(lines[i]);
        const lonRaw = lonIdx>=0? cols[lonIdx] : null;
        const latRaw = latIdx>=0? cols[latIdx] : null;
        if (lonRaw==null || latRaw==null) continue;
        const lonV = num(lonRaw), latV = num(latRaw);
        let ts = NaN;
        if (tidx>=0){
          const tv = cols[tidx];
          const n = Number(tv);
          if (Number.isFinite(n)){
            ts = (n<1e12 ? n*1000 : n);
          }else{
            const t2=new Date(String(tv).replace(' ','T')).getTime();
            if (Number.isFinite(t2)) ts=t2;
          }
        }
        if (!Number.isFinite(ts)) ts = Date.now() + i; // 没时间也能画，给个递增时间
        const useDeg = Math.abs(lonV)<=180 && Math.abs(latV)<=90;
        const obj = useDeg
          ? { ts, longitude: lonV, latitude: latV }
          : { ts, lon_e6: Math.round(lonV), lat_e6: Math.round(latV) };
        if (gcjIdx>=0){
          const flag=cols[gcjIdx]; const b = String(flag).trim();
          if (b==='1' || /^true$/i.test(b)) obj.gcj = true;
        }
        out.push(obj);
      }
      return out;
    }

    /************ GPX 解析 ************/
    function parseGPX(text){
      const doc = new DOMParser().parseFromString(text, 'application/xml');
      const out=[];
      const pick = (el)=>el ? el.textContent.trim() : '';
      // trkpt
      const trkpts = Array.from(doc.getElementsByTagName('trkpt'));
      for (const p of trkpts){
        const lat = num(p.getAttribute('lat'));
        const lon = num(p.getAttribute('lon'));
        const t = pick(p.getElementsByTagName('time')[0]||null);
        const ts = Number.isFinite(Number(t)) ? (Number(t)<1e12?Number(t)*1000:Number(t)) : new Date(t).getTime();
        const tsFinal = Number.isFinite(ts)? ts : (Date.now()+out.length);
        if (Number.isFinite(lat) && Number.isFinite(lon)){
          out.push({ ts: tsFinal, latitude: lat, longitude: lon });
        }
      }
      // wpt
      const wpts = Array.from(doc.getElementsByTagName('wpt'));
      for (const p of wpts){
        const lat = num(p.getAttribute('lat'));
        const lon = num(p.getAttribute('lon'));
        const tEl = p.getElementsByTagName('time')[0]||null;
        const t = tEl ? tEl.textContent.trim() : '';
        const ts = Number.isFinite(Number(t)) ? (Number(t)<1e12?Number(t)*1000:Number(t)) : new Date(t).getTime();
        const tsFinal = Number.isFinite(ts)? ts : (Date.now()+out.length);
        if (Number.isFinite(lat) && Number.isFinite(lon)){
          out.push({ ts: tsFinal, latitude: lat, longitude: lon });
        }
      }
      return out;
    }

    /************ KML 解析 ************/
    function parseKML(text){
      const doc = new DOMParser().parseFromString(text, 'application/xml');
      const out=[];
      const ns = (el, name)=>Array.from(el.getElementsByTagName(name));
      const txt = el=> (el? el.textContent.trim() : '');

      // gx:Track (when + gx:coord)
      const tracks = doc.getElementsByTagNameNS('*','Track');
      for (const trk of tracks){
        const when = Array.from(trk.getElementsByTagName('when')).map(e=>txt(e));
        const coords = Array.from(trk.getElementsByTagNameNS('*','coord')).map(e=>txt(e));
        const m = Math.min(when.length, coords.length);
        for (let i=0;i<m;i++){
          const ts = new Date(when[i]).getTime();
          const parts = coords[i].split(/\s+/).map(Number); // lon lat alt
          const lon=parts[0], lat=parts[1];
          if (Number.isFinite(lon)&&Number.isFinite(lat)){
            const tsFinal = Number.isFinite(ts)?ts:(Date.now()+out.length);
            out.push({ ts: tsFinal, longitude: lon, latitude: lat });
          }
        }
      }

      // LineString coordinates（可能无时间，按顺序给时间）
      const lines = doc.getElementsByTagName('LineString');
      for (const ls of lines){
        const coordNode = ls.getElementsByTagName('coordinates')[0];
        if (!coordNode) continue;
        const list = coordNode.textContent.trim().split(/\s+/);
        for (let i=0;i<list.length;i++){
          const parts = list[i].split(',').map(Number); // lon,lat,alt
          const lon=parts[0], lat=parts[1];
          if (Number.isFinite(lon)&&Number.isFinite(lat)){
            out.push({ ts: Date.now()+out.length, longitude: lon, latitude: lat });
          }
        }
      }

      // Point coordinates
      const points = doc.getElementsByTagName('Point');
      for (const pt of points){
        const coordNode = pt.getElementsByTagName('coordinates')[0];
        if (!coordNode) continue;
        const parts = coordNode.textContent.trim().split(',').map(Number);
        const lon=parts[0], lat=parts[1];
        if (Number.isFinite(lon)&&Number.isFinite(lat)){
          out.push({ ts: Date.now()+out.length, longitude: lon, latitude: lat });
        }
      }
      return out;
    }

    /************ 全局状态 ************/
    let map=null;
    let rawTrack=[]; // { ts(ms), lon_e6, lat_e6, __gcj? }
    let minTs=null, maxTs=null;
    let bigLayer=null, smallMarkers=[];
    let canvasLayer=null; // Canvas 回退
    window.__TT_SQLDB__=null;

    /************ 能力探测（PointCollection 兼容） ************/
    function getPointConsts(){
      const sizeSmall = (window.BMAP_POINT_SIZE_SMALL!==undefined) ? window.BMAP_POINT_SIZE_SMALL
                        : (BMapGL && BMapGL.PointSizeType && BMapGL.PointSizeType.SMALL) || 1;
      const shapeCircle = (window.BMAP_POINT_SHAPE_CIRCLE!==undefined) ? window.BMAP_POINT_SHAPE_CIRCLE
                        : (BMapGL && BMapGL.PointShapeType && BMapGL.PointShapeType.CIRCLE) || 0;
      const hasPC = !!(BMapGL && typeof BMapGL.PointCollection === 'function');
      return { sizeSmall, shapeCircle, hasPC };
    }

    /************ Canvas 海量点回退（只画点） ************/
    class CanvasDots extends BMapGL.Overlay {
      constructor(points, color='#5ab1ff', radius=2){
        super();
        this.points = points; // BMapGL.Point[]
        this.color = color;
        this.radius = radius;
        this._map = null;
        this._canvas = null;
        this._ctx = null;
        this._bindedDraw = this.draw.bind(this);
      }
      initialize(map){
        this._map = map;
        const canvas = this._canvas = document.createElement('canvas');
        canvas.style.position = 'absolute';
        canvas.style.left = 0; canvas.style.top = 0;
        canvas.style.pointerEvents = 'none';
        this._ctx = canvas.getContext('2d');
        map.getPanes().labelPane.appendChild(canvas);
        map.addEventListener('zoomend', this._bindedDraw);
        map.addEventListener('moveend', this._bindedDraw);
        map.addEventListener('resize', this._bindedDraw);
        this._syncSize();
        return canvas;
      }
      _syncSize(){
        const sz = this._map.getSize();
        const ratio = window.devicePixelRatio || 1;
        this._canvas.width = Math.round(sz.width * ratio);
        this._canvas.height = Math.round(sz.height * ratio);
        this._canvas.style.width = sz.width + 'px';
        this._canvas.style.height = sz.height + 'px';
        this._ctx.setTransform(ratio,0,0,ratio,0,0);
      }
      draw(){
        if (!this._map || !this._ctx) return;
        this._syncSize();
        const ctx = this._ctx;
        const radius = this.radius;
        ctx.clearRect(0,0,this._canvas.width,this._canvas.height);
        ctx.fillStyle = this.color;
        const bounds = this._map.getBounds();
        for (let i=0;i<this.points.length;i++){
          const p = this.points[i];
          if (!bounds.containsPoint(p)) continue;
          const pix = this._map.pointToPixel(p);
          ctx.beginPath();
          ctx.arc(pix.x, pix.y, radius, 0, Math.PI*2);
          ctx.fill();
        }
      }
      setPoints(points){ this.points = points || []; this.draw(); }
      setStyle({color, radius}){ if (color) this.color=color; if (radius) this.radius=radius; this.draw(); }
      remove(){
        if (!this._map) return;
        this._map.removeEventListener('zoomend', this._bindedDraw);
        this._map.removeEventListener('moveend', this._bindedDraw);
        this._map.removeEventListener('resize', this._bindedDraw);
        if (this._canvas && this._canvas.parentNode) this._canvas.parentNode.removeChild(this._canvas);
        this._canvas = null; this._ctx = null; this._map = null;
      }
    }

    /************ 统一渲染（只画点） ************/
    function clearOverlays(){
      if (bigLayer){ map.removeOverlay(bigLayer); bigLayer=null; }
      if (canvasLayer){ map.removeOverlay(canvasLayer); canvasLayer.remove?.(); canvasLayer=null; }
      if (smallMarkers.length){ for (const m of smallMarkers) map.removeOverlay(m); smallMarkers.length=0; }
    }

    function renderUnified(arr){
      clearOverlays();

      if (!arr || arr.length===0){
        map.centerAndZoom(new BMapGL.Point(116.404,39.915),12);
        document.getElementById("statsCount").textContent=`点数：0`;
        document.getElementById("statsRange").textContent=`时间范围：-`;
        document.getElementById("miniStats").textContent=`0 · —`;
        hideLoading(); return;
      }

      // 转 BD09
      const pts=[];
      for (const p of arr){
        const lng=p.lon_e6/1e6, lat=p.lat_e6/1e6;
        let bdLng, bdLat;
        if (p.__gcj===true){ [bdLng,bdLat]=gcj02ToBd09(lng,lat); }
        else { [bdLng,bdLat]=wgs84ToBd09(lng,lat); }
        pts.push(new BMapGL.Point(bdLng,bdLat));
      }
      try{ map.setViewport(pts); }catch(_){}

      const { sizeSmall, shapeCircle, hasPC } = getPointConsts();

      if (arr.length < 1000){
        const first = new BMapGL.Marker(pts[0]); first.setTitle("起点"); map.addOverlay(first); smallMarkers.push(first);
        const firstLabel=new BMapGL.Label("起点",{position:pts[0],offset:new BMapGL.Size(10,-20)});
        firstLabel.setStyle({color:"#00E0FF",backgroundColor:"rgba(0,0,0,0.6)",border:"1px solid #00E0FF",borderRadius:"6px",padding:"2px 4px",fontSize:"12px",lineHeight:"14px"});
        map.addOverlay(firstLabel); smallMarkers.push(firstLabel);

        for (let i=0;i<pts.length;i++){
          const mk = new BMapGL.Marker(pts[i]);
          mk.setTitle(`#${i}\n时间: ${tsToLocal(arr[i].ts)}`);
          map.addOverlay(mk);
          smallMarkers.push(mk);
        }
        if (pts.length>=2){
          const last = new BMapGL.Marker(pts[pts.length-1]); last.setTitle("终点"); map.addOverlay(last); smallMarkers.push(last);
          const lastLabel=new BMapGL.Label("终点",{position:pts[pts.length-1],offset:new BMapGL.Size(10,-20)});
          lastLabel.setStyle({color:"#FF4D4F",backgroundColor:"rgba(0,0,0,0.6)",border:"1px solid #FF4D4F",borderRadius:"6px",padding:"2px 4px",fontSize:"12px",lineHeight:"14px"});
          map.addOverlay(lastLabel); smallMarkers.push(lastLabel);
        }
      } else if (hasPC && sizeSmall!=null && shapeCircle!=null){
        const opts = { size: sizeSmall, shape: shapeCircle, color: '#5ab1ff' };
        const pc = new BMapGL.PointCollection(pts, opts);
        pc.addEventListener('click', e=>{
          const idx=e.index!=null?e.index:null;
          if (idx!=null && arr[idx]){
            const lbl=new BMapGL.Label(tsToLocal(arr[idx].ts), { position: e.point, offset:new BMapGL.Size(10,-20) });
            lbl.setStyle({color:"#fff",backgroundColor:"rgba(0,0,0,0.6)",border:"1px solid #30363d",borderRadius:"6px",padding:"2px 4px",fontSize:"12px",lineHeight:"14px"});
            map.addOverlay(lbl); setTimeout(()=>map.removeOverlay(lbl), 1200);
          }
        });
        map.addOverlay(pc);
        bigLayer = pc;
      } else {
        const dots = new CanvasDots(pts, '#5ab1ff', 2);
        map.addOverlay(dots);
        canvasLayer = dots;
      }

      hideLoading();
    }

    /************ 过滤（JSON） ************/
    function applyFilter_JSON(){
      showLoading("筛选并渲染中…");
      requestAnimationFrame(()=>{
        const sTs=inputToTs(document.getElementById("startInput").value);
        const eTs=inputToTs(document.getElementById("endInput").value);
        const s=(sTs==null)?minTs:sTs;
        const e=(eTs==null)?maxTs:eTs;
        if (s>e){ alert("起始时间不可晚于结束时间"); hideLoading(); return; }
        const arr=rawTrack.filter(p=>p.ts>=s&&p.ts<=e);
        renderUnified(arr);
        const count=arr.length, startTxt=(count>0)?tsToLocal(arr[0].ts):"-", endTxt=(count>0)?tsToLocal(arr[count-1].ts):"-";
        document.getElementById("statsCount").textContent=`点数：${count}`;
        document.getElementById("statsRange").textContent=`时间范围：${startTxt} → ${endTxt}`;
        document.getElementById("miniStats").textContent=`${count} · ${startTxt} → ${endTxt}`;
      });
    }

    /************ 过滤（DB） ************/
    function applyFilter_DB(){
      const sess=window.__TT_SQLDB__; if (!sess){ applyFilter_JSON(); return; }
      showLoading("数据库查询与渲染中…");
      requestAnimationFrame(()=>{
        const sTs=inputToTs(document.getElementById("startInput").value);
        const eTs=inputToTs(document.getElementById("endInput").value);
        const s=(sTs==null)?minTs:sTs, e=(eTs==null)?maxTs:eTs;
        if (s>e){ alert("起始时间不可晚于结束时间"); hideLoading(); return; }

        const { db, table, tsCol, lonCol, latCol, gcjLatCol, gcjLonCol, isMarsCol, tsIsMs } = sess;
        const qS = tsIsMs ? Math.floor(s) : Math.floor(s/1000);
        const qE = tsIsMs ? Math.floor(e) : Math.floor(e/1000);

        const sel = [
          `${tsCol} AS _ts`,
          `${lonCol} AS _lon`,
          `${latCol} AS _lat`,
          gcjLatCol ? `${gcjLatCol} AS _gclat` : null,
          gcjLonCol ? `${gcjLonCol} AS _gclon` : null,
          isMarsCol ? `${isMarsCol} AS _ismars` : null
        ].filter(Boolean).join(", ");
        const sql=`SELECT ${sel} FROM ${table} WHERE ${tsCol} BETWEEN ? AND ? ORDER BY ${tsCol} ASC;`;

        let stmt;
        try{
          stmt = db.prepare(sql); stmt.bind([qS,qE]);
          const arr=[];
          while (stmt.step()){
            const row=stmt.getAsObject();
            const ts = tsIsMs ? Number(row._ts) : Number(row._ts)*1000;
            const lon=Number(row._lon), lat=Number(row._lat);
            const looksDeg=Number.isFinite(lon)&&Number.isFinite(lat)&&Math.abs(lon)<=180&&Math.abs(lat)<=90;
            const lon_e6=looksDeg?Math.round(lon*1e6):Math.round(lon);
            const lat_e6=looksDeg?Math.round(lat*1e6):Math.round(lat);
            let isGcj=false;
            if (typeof row._ismars!=="undefined" && Number(row._ismars)===1) isGcj=true;
            else if (typeof row._gclat!=="undefined" && typeof row._gclon!=="undefined"){
              const glat=Number(row._gclat), glon=Number(row._gclon);
              if (Number.isFinite(glat)&&Number.isFinite(glon)) isGcj=true;
            }
            arr.push({ ts, lon_e6, lat_e6, __gcj:isGcj });
          }
          stmt.free();

          renderUnified(arr);
          const count=arr.length, startTxt=(count>0)?tsToLocal(arr[0].ts):"-", endTxt=(count>0)?tsToLocal(arr[count-1].ts):"-";
          document.getElementById("statsCount").textContent=`点数：${count}`;
          document.getElementById("statsRange").textContent=`时间范围：${startTxt} → ${endTxt}`;
          document.getElementById("miniStats").textContent=`${count} · ${startTxt} → ${endTxt}`;
        }catch(err){
          if (stmt) try{ stmt.free(); }catch(_){}
          const fe=document.getElementById("fileError"); fe.style.display="block"; fe.textContent=`SQLite 查询失败：${err.message}`;
          console.error(err); renderUnified([]);
        }
      });
    }

    function applyFilter(){ if (window.__TT_SQLDB__) applyFilter_DB(); else applyFilter_JSON(); }
    function resetRange(){ document.getElementById("startInput").value=tsToLocalInput(minTs); document.getElementById("endInput").value=tsToLocalInput(maxTs); applyFilter(); }

    /************ 数据加载（仅保留时间+坐标） ************/
    function setTrackData(arr, sourceLabel="内联/JSON"){
      showLoading("解析数据…");
      window.__TT_SQLDB__=null;
      if (!Array.isArray(arr)) { hideLoading(); throw new Error("数据需为数组"); }
      const cleaned=[];
      for (const p of arr){
        const ts=parseTsFlexible(p), deg=pickDegFlexible(p);
        if (!Number.isFinite(ts) || !deg) continue;
        cleaned.push({ ts: (ts<1e12?ts*1000:ts), lon_e6: Math.round(deg.lng*1e6), lat_e6: Math.round(deg.lat*1e6), __gcj: !!(p.__gcj || p.gcj) });
      }
      cleaned.sort((a,b)=>a.ts-b.ts);
      if (cleaned.length>0){ minTs=cleaned[0].ts; maxTs=cleaned[cleaned.length-1].ts; }
      else { const now=Date.now(); minTs=now-3600_000; maxTs=now; }

      const fileStatus=document.getElementById("fileStatus");
      fileStatus.style.display="block";
      fileStatus.textContent=`已加载（${sourceLabel}）：${cleaned.length} 条`;
      document.getElementById("fileError").style.display="none";

      const s=document.getElementById("startInput"), e=document.getElementById("endInput");
      s.min=tsToLocalInput(minTs); s.max=tsToLocalInput(maxTs);
      e.min=tsToLocalInput(minTs); e.max=tsToLocalInput(maxTs);
      s.value=tsToLocalInput(minTs); e.value=tsToLocalInput(maxTs);

      rawTrack=cleaned;
      applyFilter();
    }

    function loadFromInlineScript(){
      const node=document.getElementById('trackData');
      const rawText=node.textContent.trim();
      try{ setTrackData(JSON.parse(rawText||"[]"), "内联 trackData"); }
      catch(e){ const fe=document.getElementById("fileError"); fe.style.display="block"; fe.textContent=`内联 JSON 解析失败：${e.message}`; hideLoading(); }
    }

    // sql.js init once
    let SQL_INIT_PROMISE=null;
    function initSqlJsOnce(){
      if (!SQL_INIT_PROMISE){
        SQL_INIT_PROMISE=initSqlJs({ locateFile:file=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${file}` });
      }
      return SQL_INIT_PROMISE;
    }

    async function loadFromSQLite(file){
      const fileError=document.getElementById("fileError");
      const fileStatus=document.getElementById("fileStatus");
      fileError.style.display="none"; fileStatus.style.display="none";
      showLoading("加载 SQLite…");
      try{
        const SQL=await initSqlJsOnce();
        const buf=new Uint8Array(await file.arrayBuffer());
        const db=new SQL.Database(buf);

        const tables=db.exec(`SELECT name FROM sqlite_master WHERE type='table'`)?.flatMap(r=>r.values.map(v=>String(v[0])))||[];
        const prefer=["location","Location","locations","userMark","frequentIndexTable","points","track","tracking"];
        let candidate=prefer.find(n=>tables.includes(n))||null;

        function tableInfo(name){ return db.exec(`PRAGMA table_info(${JSON.stringify(name)})`); }
        function colSet(info){ return new Set(info[0]?.values?.map(v=>String(v[1]))||[]); }
        function pickOne(names,cands){ for (const c of cands) if (names.has(c)) return c; return null; }

        const need = {
          ts : ["ts","timestamp","time_ms","time","ts_ms","created_at","recorded_at"],
          lon: ["lon_e6","longitude_e6","lon_e7","longitude_e7","lon","longitude","lng"],
          lat: ["lat_e6","latitude_e6","lat_e7","latitude_e7","lat","latitude"]
        };

        function findTable(){
          const tryOne=(t)=>{ const info=tableInfo(t); if(!info||info.length===0) return null;
            const names=colSet(info);
            const tsCol=pickOne(names,need.ts), lonCol=pickOne(names,need.lon), latCol=pickOne(names,need.lat);
            return (tsCol&&lonCol&&latCol)?{table:t,names,tsCol,lonCol,latCol}:null; };
          if (candidate){ const r=tryOne(candidate); if (r) return r; }
          for (const t of tables){ const r=tryOne(t); if (r) return r; }
          return null;
        }

        const found=findTable();
        if (!found) throw new Error("未找到同时包含时间/经度/纬度关键列的表");

        const { table, tsCol, lonCol, latCol, names } = found;

        const hasGcjLat = names.has("gcj02latitude");
        const hasGcjLon = names.has("gcj02longitude");
        const hasIsMars = names.has("isMarsLocation");

        const mm=db.exec(`SELECT MIN(${tsCol}) AS min_ts, MAX(${tsCol}) AS max_ts FROM ${table};`);
        const row=mm[0]?.values?.[0]||[];
        const rawMin = Number(row[0]);
        const rawMax = Number(row[1]);
        if (!Number.isFinite(rawMin)||!Number.isFinite(rawMax)) throw new Error("无法读取 MIN/MAX(ts)");

        const tsIsMs = (rawMin >= 1e12 || rawMax >= 1e12);
        minTs = tsIsMs ? rawMin : rawMin * 1000;
        maxTs = tsIsMs ? rawMax : rawMax * 1000;

        window.__TT_SQLDB__={
          db, table, tsCol, lonCol, latCol,
          gcjLatCol: hasGcjLat ? "gcj02latitude"  : null,
          gcjLonCol: hasGcjLon ? "gcj02longitude" : null,
          isMarsCol: hasIsMars ? "isMarsLocation" : null,
          tsIsMs
        };

        const s=document.getElementById("startInput"), e=document.getElementById("endInput");
        s.min=tsToLocalInput(minTs); s.max=tsToLocalInput(maxTs);
        e.min=tsToLocalInput(minTs); e.max=tsToLocalInput(maxTs);
        s.value=tsToLocalInput(minTs); e.value=tsToLocalInput(maxTs);

        document.getElementById("fileStatus").style.display="block";
        document.getElementById("fileStatus").textContent=`已连接 SQLite（${file.name} / 表：${table}）`;

        applyFilter_DB();
      }catch(e){
        const fe=document.getElementById("fileError");
        fe.style.display="block";
        fe.textContent=`SQLite 解析失败：${e.message}`;
        console.error(e);
        hideLoading();
        window.__TT_SQLDB__=null;
      }
    }

    /************ 文件加载分发：JSON / SQLite / CSV / GPX / KML ************/
    async function loadFromFile(file){
      const name=(file?.name||"").toLowerCase();
      try{
        if (name.endsWith(".json")){
          const txt = await file.text(); const json = JSON.parse(txt);
          setTrackData(json, file.name);
        } else if (name.endsWith(".db") || name.endsWith(".sqlite")){
          await loadFromSQLite(file);
        } else if (name.endsWith(".csv")){
          showLoading("解析 CSV…");
          const txt = await file.text();
          const arr = parseCSV(txt);
          setTrackData(arr, file.name);
        } else if (name.endsWith(".gpx")){
          showLoading("解析 GPX…");
          const txt = await file.text();
          const arr = parseGPX(txt);
          setTrackData(arr, file.name);
        } else if (name.endsWith(".kml")){
          showLoading("解析 KML…");
          const txt = await file.text();
          const arr = parseKML(txt);
          setTrackData(arr, file.name);
        } else {
          // 尝试按文本猜测
          const txt = await file.text();
          if (txt.trim().startsWith('{') || txt.trim().startsWith('[')){
            setTrackData(JSON.parse(txt), file.name);
          } else if (txt.includes('<gpx')){
            setTrackData(parseGPX(txt), file.name);
          } else if (txt.includes('<kml')){
            setTrackData(parseKML(txt), file.name);
          } else if (txt.includes(',') && txt.split('\n')[0].includes(',')){
            setTrackData(parseCSV(txt), file.name);
          } else {
            throw new Error("未知格式：请提供 JSON/SQLite/CSV/GPX/KML");
          }
        }
      }catch(e){
        const fe=document.getElementById("fileError");
        fe.style.display="block";
        fe.textContent=`文件加载失败：${e.message}`;
        console.error(e);
        hideLoading();
      }
    }

    /************ 面板与初始化 ************/
    function setPanelCollapsed(collapsed){
      const panel=document.getElementById("infoPanel");
      const btn=document.getElementById("togglePanel");
      if (collapsed){ panel.classList.add("collapsed"); btn.textContent="展开"; btn.setAttribute("aria-expanded","false"); localStorage.setItem("tt_panel_collapsed","1"); }
      else { panel.classList.remove("collapsed"); btn.textContent="收起"; btn.setAttribute("aria-expanded","true"); localStorage.setItem("tt_panel_collapsed","0"); }
    }

    function init(){
      map=new BMapGL.Map("map",{ enableRotate:false, enableTilt:false });
      map.centerAndZoom(new BMapGL.Point(116.404,39.915),12);
      map.addControl(new BMapGL.ZoomControl());
      map.enableScrollWheelZoom(true);

      setPanelCollapsed(localStorage.getItem("tt_panel_collapsed")==="1");
      document.getElementById("togglePanel").addEventListener("click",()=>setPanelCollapsed(!document.getElementById("infoPanel").classList.contains("collapsed")));

      document.getElementById("applyBtn").addEventListener("click",applyFilter);
      document.getElementById("resetBtn").addEventListener("click",resetRange);
      document.getElementById("startInput").addEventListener("change",applyFilter);
      document.getElementById("endInput").addEventListener("change",applyFilter);

      document.getElementById("fileInput").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if (f) loadFromFile(f); });
      const dz=document.getElementById("dropzone");
      const prevent=ev=>{ ev.preventDefault(); ev.stopPropagation(); };
      ["dragenter","dragover","dragleave","drop"].forEach(evt=>dz.addEventListener(evt,prevent,false));
      dz.addEventListener("dragenter",()=>dz.classList.add("dragover"));
      dz.addEventListener("dragover",()=>dz.classList.add("dragover"));
      dz.addEventListener("dragleave",()=>dz.classList.remove("dragover"));
      dz.addEventListener("drop",(ev)=>{ dz.classList.remove("dragover"); const f=ev.dataTransfer.files?.[0]; if (f) loadFromFile(f); });

      if (location.protocol === 'file:'){
        const fe=document.getElementById("fileError");
        fe.style.display="block";
        fe.textContent="提示：请通过 http(s) 本地服务打开（如 python -m http.server 8080），避免 file:// 下第三方统计的 CORS 报错。";
      }

      loadFromInlineScript();
    }
    init();
  </script>
</body>
</html>
